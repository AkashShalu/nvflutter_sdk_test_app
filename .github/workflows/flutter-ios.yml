name: ğŸš€ Flutter CI - iOS Release (Professional & Stable)

on:
  push:
    branches: [ main ]
    paths:
      - "ios/**"
      - "lib/**"
      - "pubspec.yaml"
      - "pubspec.lock"
      - ".github/workflows/ios.yml"

jobs:
  build-ios:
    runs-on: macos-latest
    timeout-minutes: 50

    env:
      APP_SCHEME: Runner
      WORKSPACE: Runner.xcworkspace
      CONFIGURATION: Release
      DEVELOPMENT_TEAM: 4JW4924F8P     # âš ï¸ Update if needed
      KEYCHAIN_NAME: build.keychain

      # App Store Connect API (set in GitHub Secrets)
      APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
      APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
      APP_STORE_CONNECT_API_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}

    steps:
      # ----------------------------------------
      # 1. Source Checkout
      # ----------------------------------------
      - name: ğŸ“ Checkout Source Code
        uses: actions/checkout@v4

      # ----------------------------------------
      # 2. Setup Flutter
      # ----------------------------------------
      - name: ğŸ›  Setup Flutter SDK
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.35.7"
          channel: stable

      # ----------------------------------------
      # 3. Cache Flutter Dependencies
      # ----------------------------------------
      - name: ğŸ’¾ Cache Pub Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-pub-${{ hashFiles('pubspec.lock') }}

      - name: ğŸ“¦ Flutter Pub Get
        run: flutter pub get

      # ----------------------------------------
      # 4. CocoaPods Setup
      # ----------------------------------------
      - name: ğŸ“š Install CocoaPods Dependencies
        run: |
          cd ios
          pod install --repo-update
          cd ..

      # ---------------------------
      # 4. Auto Increment Build Number
      # ---------------------------
      - name: ğŸ”¢ Auto-increment iOS Build Number
        run: |
          BUILD_NUMBER=$(date +%s)
          echo "Using build number: $BUILD_NUMBER"
          plutil -replace CFBundleVersion -string "$BUILD_NUMBER" ios/Runner/Info.plist


      # ----------------------------------------
      # 5. Decrypt Signing Assets
      # ----------------------------------------
      - name: ğŸ” Decrypt Certificates & Provisioning Profiles
        env:
          CERT_PASSWORD: ${{ secrets.CERT_PASSWORD }}
        run: |
          mkdir -p ios/certs
          for FILE in appleDistribution.p12 nvFlutterTestApp_Main_Target_Release.mobileprovision nvFlutterTestApp_Ext_Target_Release.mobileprovision; do  
            echo "ğŸ”“ Decrypting $FILE..."
            openssl aes-256-cbc -k "$CERT_PASSWORD" \
              -in "pf_ios/${FILE}.enc" -out "ios/certs/${FILE}" -d
          done

      # ----------------------------------------
      # 6. Setup Keychain & Import Certificate
      # ----------------------------------------
      - name: ğŸ”‘ Setup Keychain & Import Certificate
        env:
          CERT_PASSWORD: ${{ secrets.CERT_PASSWORD }}
        run: |
          security create-keychain -p "$CERT_PASSWORD" "$KEYCHAIN_NAME"
          security default-keychain -s "$KEYCHAIN_NAME"
          security unlock-keychain -p "$CERT_PASSWORD" "$KEYCHAIN_NAME"
          security import ios/certs/appleDistribution.p12 -k "$KEYCHAIN_NAME" -P "$CERT_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple: -s -k "$CERT_PASSWORD" "$KEYCHAIN_NAME"
          echo "ğŸ” Keychain configured successfully."

      # ----------------------------------------
      # 7. Install Provisioning Profiles
      # ----------------------------------------
      - name: ğŸ“ Install Provisioning Profiles
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp ios/certs/*.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/
          echo "âœ… Installed Provisioning Profiles:"
          ls -la ~/Library/MobileDevice/Provisioning\ Profiles || true

      # ----------------------------------------
      # 8. Fix Pod Signing Conflicts
      # ----------------------------------------
      - name: ğŸ›  Fix Pod Signing (Prevent Build Conflicts)
        run: |
          sed -i '' 's/PROVISIONING_PROFILE_SPECIFIER = .*;/PROVISIONING_PROFILE_SPECIFIER = "";/g' ios/Pods/Pods.xcodeproj/project.pbxproj || true
          sed -i '' 's/PROVISIONING_PROFILE = .*;/PROVISIONING_PROFILE = "";/g' ios/Pods/Pods.xcodeproj/project.pbxproj || true
          sed -i '' 's/CODE_SIGN_STYLE = Manual;/CODE_SIGN_STYLE = Automatic;/g' ios/Pods/Pods.xcodeproj/project.pbxproj || true
          sed -i '' 's/CODE_SIGN_IDENTITY = "Apple Distribution";/CODE_SIGN_IDENTITY = "";/g' ios/Pods/Pods.xcodeproj/project.pbxproj || true

      # ----------------------------------------
      # 9. Optional Debug Build (Ensures Build Works)
      # ----------------------------------------
      - name: ğŸ§ª Flutter Build iOS (Debug, No Codesign)
        run: flutter build ios --debug --no-codesign

      # ----------------------------------------
      # 10. Install xcpretty for better logs
      # ----------------------------------------
      - name: ğŸ“¦ Install xcpretty (Better Xcode Logs)
        run: |
          gem install xcpretty --no-document || true
          xcpretty --version || true

      # ----------------------------------------
      # 11. Archive & Export IPA (Ad-Hoc)
      # ----------------------------------------
      - name: ğŸ“¦ Archive & Export iOS (.ipa)
        run: |
          cd ios
          mkdir -p build

          echo "ğŸ§¹ Cleaning previous builds..."
          xcodebuild clean -workspace "$WORKSPACE" -scheme "$APP_SCHEME" -configuration "$CONFIGURATION"

          echo "ğŸ“¥ Copying ExportOptions.plist..."
          cp ../pf_ios/ExportOptions.plist ExportOptions.plist || { echo "âŒ ExportOptions.plist missing"; exit 1; }

          ARCHIVE_PATH="$PWD/build/${APP_SCHEME}.xcarchive"

          echo "ğŸš€ Archiving project..."
          xcodebuild -workspace "$WORKSPACE" \
            -scheme "$APP_SCHEME" \
            -configuration "$CONFIGURATION" \
            -sdk iphoneos \
            -archivePath "$ARCHIVE_PATH" \
            DEVELOPMENT_TEAM="$DEVELOPMENT_TEAM" \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGN_IDENTITY="Apple Distribution" \
            -allowProvisioningUpdates \
            archive | xcpretty

          echo "ğŸ“¤ Exporting .ipa file..."
          xcodebuild -exportArchive \
            -archivePath "$ARCHIVE_PATH" \
            -exportPath "$PWD/build" \
            -exportOptionsPlist ExportOptions.plist \
            -allowProvisioningUpdates | tee export.log

          ls -la build/*.ipa || echo "âŒ IPA not generated!"

          # cd ..

      # ----------------------------------------
      # 12. Upload to TestFlight via Fastlane
      # ----------------------------------------
      - name: Upload to TestFlight via Fastlane
        run: |
          echo "ğŸ”‘ Generating Fastlane API key JSON..."
      
          echo "$APP_STORE_CONNECT_API_KEY_BASE64" | base64 --decode > AuthKey.p8
      
          # keep newlines and escape for JSON
          KEY_CONTENT=$(awk '{printf "%s\\n", $0}' AuthKey.p8 | sed 's/"/\\"/g')
      
          cat > fastlane_api_key.json <<EOF
          {
            "key_id": "$APP_STORE_CONNECT_API_KEY_ID",
            "issuer_id": "$APP_STORE_CONNECT_ISSUER_ID",
            "key": "$KEY_CONTENT",
            "in_house": false
          }
          EOF
      
          echo "âœ… fastlane_api_key.json created"
          cat fastlane_api_key.json | head -10
      
          echo "ğŸ“¤ Uploading to TestFlight..."
          sudo gem install fastlane --no-document
      
          fastlane deliver \
            --api_key_path fastlane_api_key.json \
            --ipa ios/build/nvflutter_sdk_test_app.ipa \
            --skip_screenshots \
            --skip_metadata \
            --force

            
          cd ..
      # ----------------------------------------
      # 13. Upload Artifact
      # ----------------------------------------
      - name: ğŸ“ Upload .ipa Artifact
        uses: actions/upload-artifact@v4
        with:
          name: flutter-ios-ipa
          path: ios/build/*.ipa
