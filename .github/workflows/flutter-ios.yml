name: üöÄ Flutter CI - iOS AdHoc Build (Professional)

on:
  push:
    branches: [ main ]
    paths:
      - "ios/**"
      - "lib/**"
      - "pubspec.*"
      - ".github/workflows/flutter-ios.yml"

jobs:
  build-ios:
    runs-on: macos-latest
    timeout-minutes: 40  # Prevents infinite hangs

    env:
      APP_SCHEME: Runner
      WORKSPACE: Runner.xcworkspace
      CONFIGURATION: Release
      DEVELOPMENT_TEAM: 4JW4924F8P   # Change to your Apple Team ID
      KEYCHAIN_NAME: build.keychain

    steps:
    # -------------------------
    # 1Ô∏è‚É£ Checkout Code
    # -------------------------
    - name: üì• Checkout Source Code
      uses: actions/checkout@v4

    # -------------------------
    # 2Ô∏è‚É£ Setup Flutter SDK
    # -------------------------
    - name: üõ†Ô∏è Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.35.7'
        channel: stable

    # -------------------------
    # 3Ô∏è‚É£ Cache Dependencies
    # -------------------------
    - name: ‚ö° Cache Flutter Pub Packages
      uses: actions/cache@v4
      with:
        path: ~/.pub-cache
        key: ${{ runner.os }}-pub-${{ hashFiles('pubspec.lock') }}

    - name: üì¶ Install Dependencies
      run: flutter pub get

    # -------------------------
    # 4Ô∏è‚É£ Install CocoaPods
    # -------------------------
    - name: üìö Install CocoaPods
      run: |
        cd ios
        pod install --repo-update
        cd ..

    # -------------------------
    # 5Ô∏è‚É£ Decrypt Certificates & Provision Profiles
    # -------------------------
    - name: üîê Decrypt iOS Signing Files
      env:
        CERT_PASSWORD: ${{ secrets.CERT_PASSWORD }}
      run: |
        mkdir -p ios/certs
        for FILE in appleDistribution.p12 nvFlutterTestApp_Main_Target_AdHoc.mobileprovision nvFlutterTestApp_Ext_Target_AdHoc.mobileprovision; do
          echo "‚û°Ô∏è Decrypting $FILE"
          openssl aes-256-cbc -k "$CERT_PASSWORD" \
          -in "pf_ios/${FILE}.enc" -out "ios/certs/${FILE}" -d
        done

    # -------------------------
    # 6Ô∏è‚É£ Setup Keychain & Import Certificate
    # -------------------------
    - name: üóùÔ∏è Setup Keychain & Import Certificate
      env:
        CERT_PASSWORD: ${{ secrets.CERT_PASSWORD }}
      run: |
        security create-keychain -p "$CERT_PASSWORD" "$KEYCHAIN_NAME"
        security unlock-keychain -p "$CERT_PASSWORD" "$KEYCHAIN_NAME"
        security import ios/certs/appleDistribution.p12 -k "$KEYCHAIN_NAME" -P "$CERT_PASSWORD" -T /usr/bin/codesign
        security set-key-partition-list -S apple-tool:,apple: -s -k "$CERT_PASSWORD" "$KEYCHAIN_NAME"

    # -------------------------
    # 7Ô∏è‚É£ Install Provisioning Profiles
    # -------------------------
    - name: üì≤ Install Provisioning Profiles
      run: |
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        cp ios/certs/*.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/

    # -------------------------
    # 8Ô∏è‚É£ Remove Code Signing from Pods (Avoid Profile Errors)
    # -------------------------
    - name: üßπ Fix Pod Signing Issue (Optional)
      run: |
        sed -i '' 's/PROVISIONING_PROFILE_SPECIFIER = .*;/PROVISIONING_PROFILE_SPECIFIER = "";/g' ios/Pods/Pods.xcodeproj/project.pbxproj
        sed -i '' 's/PROVISIONING_PROFILE = .*;/PROVISIONING_PROFILE = "";/g' ios/Pods/Pods.xcodeproj/project.pbxproj
        sed -i '' 's/CODE_SIGN_STYLE = Manual;/CODE_SIGN_STYLE = Automatic;/g' ios/Pods/Pods.xcodeproj/project.pbxproj

      # -------------------------
      # 1Ô∏è‚É£1Ô∏è‚É£ Build & Archive App
      # -------------------------
    - name: üèóÔ∏è Build & Archive iOS App (AdHoc)
      run: |
          cd ios
          mkdir -p build

          echo "üßπ Cleaning previous build..."
          xcodebuild clean -workspace "$WORKSPACE" -scheme "$APP_SCHEME" -configuration "$CONFIGURATION"

          echo "üì• Copying and Generating ExportOptions.plist from pf_ios..."
          cp ../pf_ios/ExportOptions.plist ExportOptions.plist

          echo "üì¶ Archiving app..."
          ARCHIVE_PATH="$PWD/build/${APP_SCHEME}.xcarchive"

          xcodebuild -workspace "$WORKSPACE" \
            -scheme "$APP_SCHEME" \
            -configuration "$CONFIGURATION" \
            -sdk iphoneos \
            -archivePath "$ARCHIVE_PATH" \
            DEVELOPMENT_TEAM="$DEVELOPMENT_TEAM" \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGN_IDENTITY="Apple Distribution" \
            -allowProvisioningUpdates \
            archive | xcpretty

          echo "üì¶ Exporting .ipa..."
          xcodebuild -exportArchive \
            -archivePath "$ARCHIVE_PATH" \
            -exportPath "$PWD/build" \
            -exportOptionsPlist ExportOptions.plist \
            -allowProvisioningUpdates \
            -verbose | tee export.log

          ls -la build/*.ipa || echo "‚ùå No IPA found!"
          cd ..

    # -------------------------
    # 1Ô∏è‚É£1Ô∏è‚É£ Upload Artifact
    # -------------------------
    - name: üì§ Upload IPA File
      uses: actions/upload-artifact@v4
      with:
        name: flutter-ios-ipa
        path: ios/build/*.ipa
