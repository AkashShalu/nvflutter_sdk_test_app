name: ğŸš€ Flutter CI â€“ iOS Release (Enterprise & Production Ready)

on:
  push:
    branches: [ main ]
    paths:
      - "ios/**"
      - "lib/**"
      - "pubspec.yaml"
      - "pubspec.lock"
      - ".github/workflows/flutter-ios.yml"

jobs:
  ios-build-release:
    name: ğŸ“± Build & Upload iOS App (TestFlight)
    runs-on: macos-latest
    timeout-minutes: 45

    # -------------------------------------------------
    # Global Environment Setup
    # -------------------------------------------------
    env:
      APP_SCHEME: "Runner"
      WORKSPACE: "Runner.xcworkspace"
      CONFIGURATION: "Release"
      DEVELOPMENT_TEAM: "4JW4924F8P"
      KEYCHAIN_NAME: "build.keychain-db"

      # App Store Connect API Keys (from GitHub Secrets)
      APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
      APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
      APP_STORE_CONNECT_API_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}

    steps:
    # -------------------------------------------------
    # 1. Checkout Project Source
    # -------------------------------------------------
    - name: ğŸ“ Checkout Source Code
      uses: actions/checkout@v4

    # -------------------------------------------------
    # 2. Install Flutter SDK
    # -------------------------------------------------
    - name: ğŸ›  Install Flutter SDK
      uses: subosito/flutter-action@v2
      with:
        flutter-version: "3.35.7"
        channel: stable

    # -------------------------------------------------
    # 3. Cache Flutter Packages
    # -------------------------------------------------
    - name: ğŸ’¾ Cache Flutter Pub Packages
      uses: actions/cache@v4
      with:
        path: ~/.pub-cache
        key: pub-cache-${{ runner.os }}-${{ hashFiles('pubspec.lock') }}

    - name: ğŸ“¦ Flutter Pub Get
      run: flutter pub get

    # -------------------------------------------------
    # 4. Install iOS Dependencies (CocoaPods)
    # -------------------------------------------------
    - name: ğŸ“š Install CocoaPods Dependencies
      run: |
        cd ios
        pod install --repo-update

    # -------------------------------------------------
    # 5. Auto-Increment Build Number
    # -------------------------------------------------
    - name: ğŸ”¢ Auto-Increment iOS Build Number
      run: |
        BUILD_NUMBER="${{ github.run_number }}"
        echo "Using CFBundleVersion: $BUILD_NUMBER"
        plutil -replace CFBundleVersion -string "$BUILD_NUMBER" ios/Runner/Info.plist

    # -------------------------------------------------
    # 6. Decrypt Signing Certificates & Profiles
    # -------------------------------------------------
    - name: ğŸ” Decrypt Certificates & Provisioning Profiles
      env:
        CERT_PASSWORD: ${{ secrets.CERT_PASSWORD }}
      run: |
        mkdir -p ios/certs
        for FILE in appleDistribution.p12 nvFlutterTestApp_Main_Target_Release.mobileprovision nvFlutterTestApp_Ext_Target_Release.mobileprovision; do
          openssl aes-256-cbc -k "$CERT_PASSWORD" -in "pf_ios/${FILE}.enc" -out "ios/certs/${FILE}" -d
        done

    # -------------------------------------------------
    # 7. Configure macOS Keychain for Code Signing
    # -------------------------------------------------
    - name: ğŸ”‘ Setup macOS Keychain & Import Certificates
      env:
        CERT_PASSWORD: ${{ secrets.CERT_PASSWORD }}
      run: |
        security create-keychain -p "$CERT_PASSWORD" "$KEYCHAIN_NAME"
        security default-keychain -s "$KEYCHAIN_NAME"
        security unlock-keychain -p "$CERT_PASSWORD" "$KEYCHAIN_NAME"
        security import ios/certs/appleDistribution.p12 -k "$KEYCHAIN_NAME" -P "$CERT_PASSWORD" -T /usr/bin/codesign
        security set-key-partition-list -S apple-tool:,apple: -s -k "$CERT_PASSWORD" "$KEYCHAIN_NAME"

    # -------------------------------------------------
    # 8. Install Provisioning Profiles
    # -------------------------------------------------
    - name: ğŸ“ Install Provisioning Profiles
      run: |
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        cp ios/certs/*.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/

    # -------------------------------------------------
    # 9. Build Flutter iOS (No Codesign For Sanity Check)
    # -------------------------------------------------
    - name: ğŸ§ª Flutter iOS Debug Build (Validation Only)
      run: flutter build ios --debug --no-codesign

    # -------------------------------------------------
    # 10. Install xcpretty (Better Xcode Output)
    # -------------------------------------------------
    - name: ğŸ“¦ Install xcpretty
      run: |
        gem install xcpretty --no-document || true

    # -------------------------------------------------
    # 11. Archive & Export iOS IPA
    # -------------------------------------------------
    - name: ğŸ“¦ Archive & Export iOS IPA
      run: |
        cd ios
        mkdir -p build

        echo "ğŸ§¹ Cleaning previous build..."
        xcodebuild clean -workspace "$WORKSPACE" -scheme "$APP_SCHEME" -configuration "$CONFIGURATION"

        cp ../pf_ios/ExportOptions.plist ExportOptions.plist

        ARCHIVE_PATH="$PWD/build/$APP_SCHEME.xcarchive"

        echo "ğŸš€ Building archive..."
        xcodebuild -workspace "$WORKSPACE" \
          -scheme "$APP_SCHEME" \
          -configuration "$CONFIGURATION" \
          -sdk iphoneos \
          -archivePath "$ARCHIVE_PATH" \
          DEVELOPMENT_TEAM="$DEVELOPMENT_TEAM" \
          CODE_SIGN_STYLE=Manual \
          CODE_SIGN_IDENTITY="Apple Distribution" \
          archive | xcpretty

        echo "ğŸ“¤ Exporting IPA..."
        xcodebuild -exportArchive \
          -archivePath "$ARCHIVE_PATH" \
          -exportPath "$PWD/build/export" \
          -exportOptionsPlist ExportOptions.plist

        echo "âœ… Generated IPA files:"
        ls -la build/export/*.ipa

    # -------------------------------------------------
    # 12. Upload IPA to TestFlight (Fastlane Deliver)
    # -------------------------------------------------
    - name: ğŸš€ Upload IPA to TestFlight
      run: |
        echo "$APP_STORE_CONNECT_API_KEY_BASE64" | base64 --decode > AuthKey.p8

        KEY_CONTENT=$(awk '{printf "%s\\n", $0}' AuthKey.p8 | sed 's/"/\\"/g')

        cat > fastlane_api_key.json <<EOF
        {
          "key_id": "$APP_STORE_CONNECT_API_KEY_ID",
          "issuer_id": "$APP_STORE_CONNECT_ISSUER_ID",
          "key": "$KEY_CONTENT",
          "in_house": false
        }
        EOF

        sudo gem install fastlane -N

        fastlane deliver \
          --api_key_path fastlane_api_key.json \
          --ipa ios/build/export/*.ipa \
          --skip_screenshots \
          --skip_metadata \
          --run_precheck_before_submit false \
          --force \
          --verbose

    # -------------------------------------------------
    # 13. Upload Generated IPA as Artifact
    # -------------------------------------------------
    - name: ğŸ“ Upload IPA Artifact
      uses: actions/upload-artifact@v4
      with:
        name: flutter-ios-ipa
        path: ios/build/export/*.ipa
