name: Flutter CI - iOS AdHoc (Fixed & Clean)

on:
  push:
    branches: [ main ]
    paths:
      - 'ios/**'
      - 'lib/**'
      - 'pubspec.yaml'
      - 'pubspec.lock'
      - '.github/workflows/flutter-ios.yml'

jobs:
  build-ios:
    runs-on: macos-latest
    timeout-minutes: 50

    env:
      APP_SCHEME: Runner
      WORKSPACE: Runner.xcworkspace
      CONFIGURATION: Release
      DEVELOPMENT_TEAM: 4JW4924F8P   # update if needed
      KEYCHAIN_NAME: build.keychain

    steps:
      - name: 1Ô∏è‚É£ Checkout source
        uses: actions/checkout@v4

      - name: 2Ô∏è‚É£ Setup Flutter SDK
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.7'
          channel: 'stable'

      - name: 3Ô∏è‚É£ Cache pub dependencies
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-pub-${{ hashFiles('pubspec.lock') }}

      - name: 4Ô∏è‚É£ Flutter pub get
        run: flutter pub get

      - name: 5Ô∏è‚É£ Install CocoaPods
        run: |
          cd ios
          pod install --repo-update
          cd ..

      # Decrypt signing assets (same files you had)
      - name: 6Ô∏è‚É£ Decrypt Signing Assets
        env:
          CERT_PASSWORD: ${{ secrets.CERT_PASSWORD }}
        run: |
          mkdir -p ios/certs
          for FILE in appleDistribution.p12 nvFlutterTestApp_Main_Target_AdHoc.mobileprovision nvFlutterTestApp_Ext_Target_AdHoc.mobileprovision; do
            echo "üîì Decrypting $FILE..."
            openssl aes-256-cbc -k "$CERT_PASSWORD" \
              -in "pf_ios/${FILE}.enc" -out "ios/certs/${FILE}" -d
          done

      # Create, set default & import into keychain (we ensure it's the default)
      - name: 7Ô∏è‚É£ Setup Keychain & Import Certificate
        env:
          CERT_PASSWORD: ${{ secrets.CERT_PASSWORD }}
        run: |
          security create-keychain -p "$CERT_PASSWORD" "$KEYCHAIN_NAME"
          # Make the new keychain the default so codesign can find certificates
          security default-keychain -s "$KEYCHAIN_NAME"
          security unlock-keychain -p "$CERT_PASSWORD" "$KEYCHAIN_NAME"
          security import ios/certs/appleDistribution.p12 -k "$KEYCHAIN_NAME" -P "$CERT_PASSWORD" -T /usr/bin/codesign
          # Ensure codesign can access the key
          security set-key-partition-list -S apple-tool:,apple: -s -k "$CERT_PASSWORD" "$KEYCHAIN_NAME"
          # Show keychain list for debugging
          security list-keychains -d user

      - name: 8Ô∏è‚É£ Install Provisioning Profiles
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp ios/certs/*.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/
          echo "üìÅ Installed provisioning profiles:"
          ls -la ~/Library/MobileDevice/Provisioning\ Profiles || true

      - name: 9Ô∏è‚É£ Fix Pod Signing (Prevents provisioning profile errors)
        run: |
          echo "Removing signing settings from Pods targets..."
          sed -i '' 's/PROVISIONING_PROFILE_SPECIFIER = .*;/PROVISIONING_PROFILE_SPECIFIER = "";/g' ios/Pods/Pods.xcodeproj/project.pbxproj || true
          sed -i '' 's/PROVISIONING_PROFILE = .*;/PROVISIONING_PROFILE = "";/g' ios/Pods/Pods.xcodeproj/project.pbxproj || true
          sed -i '' 's/CODE_SIGN_STYLE = Manual;/CODE_SIGN_STYLE = Automatic;/g' ios/Pods/Pods.xcodeproj/project.pbxproj || true
          sed -i '' 's/CODE_SIGN_IDENTITY = "Apple Distribution";/CODE_SIGN_IDENTITY = "";/g' ios/Pods/Pods.xcodeproj/project.pbxproj || true

      - name: üîü Build iOS Debug (no codesign)
        run: flutter build ios --debug --no-codesign

      # ensure xcpretty available before using it
      - name: 1Ô∏è‚É£1Ô∏è‚É£ Install xcpretty (for pretty xcode logs)
        run: |
          gem install xcpretty --no-document || true
          xcpretty --version || true

      - name: 1Ô∏è‚É£2Ô∏è‚É£ Archive & Export iOS App (AdHoc)
        run: |
          cd ios
          mkdir -p build

          echo "üßπ Cleaning previous build..."
          xcodebuild clean -workspace "$WORKSPACE" -scheme "$APP_SCHEME" -configuration "$CONFIGURATION"

          echo "üì• Copying ExportOptions.plist into ios (exactly as in working workflow)..."
          # COPY the ExportOptions where your export command will use it
          cp ../pf_ios/ExportOptions.plist ExportOptions.plist || { echo "ExportOptions.plist not found at ../pf_ios/ExportOptions.plist"; ls -la ..; exit 1; }

          echo "üì¶ Archiving app..."
          ARCHIVE_PATH="$PWD/build/${APP_SCHEME}.xcarchive"

          xcodebuild -workspace "$WORKSPACE" \
            -scheme "$APP_SCHEME" \
            -configuration "$CONFIGURATION" \
            -sdk iphoneos \
            -archivePath "$ARCHIVE_PATH" \
            DEVELOPMENT_TEAM="$DEVELOPMENT_TEAM" \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGN_IDENTITY="Apple Distribution" \
            -allowProvisioningUpdates \
            archive | xcpretty

          echo "üì¶ Exporting .ipa..."
          xcodebuild -exportArchive \
            -archivePath "$ARCHIVE_PATH" \
            -exportPath "$PWD/build" \
            -exportOptionsPlist ExportOptions.plist \
            -allowProvisioningUpdates \
            -verbose | tee export.log

          ls -la build/*.ipa || echo "‚ùå No IPA found!"
          cd ..

      - name: 1Ô∏è‚É£3Ô∏è‚É£ Upload .ipa artifact
        uses: actions/upload-artifact@v4
        with:
          name: flutter-ios-ipa
          path: ios/build/*.ipa
